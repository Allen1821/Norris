<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Terms and Conditions - Norris Precision Manufacturing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Base and Page-Specific Styles -->
  <link rel="stylesheet" href="../styles.css">
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Terms Page Specific Styles */
    .terms-page {
      background: var(--white);
    }
    
    .terms-section {
      padding: 2rem;
      max-width: 1440px;
      margin: 0 auto;
    }
    
    .terms-container {
      display: flex;
      border: 1px solid var(--light-gray);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      height: 75vh;
    }
    
    .terms-sidebar {
      width: 250px;
      background: var(--light-gray);
      border-right: 1px solid var(--accent-blue);
      padding: 1rem;
    }
    
    .terms-file-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .terms-file-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem 1rem;
      cursor: pointer;
      background: var(--white);
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    .terms-file-item i {
      color: var(--primary-blue);
    }
    
    .terms-file-item:hover {
      background: var(--light-blue);
    }
    
    .terms-file-item.active {
      background: var(--accent-blue);
      color: var(--white);
    }
    
    .terms-file-item.active i {
      color: var(--white);
    }
    
    .terms-viewer {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .pdf-controls {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      background: var(--light-gray);
      border-bottom: 1px solid var(--light-gray);
    }
    
    .pdf-title {
      margin-left: 1rem;
      font-weight: 500;
      flex-grow: 1;
    }
    
    .primary-btn {
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }
    
    .primary-btn:hover {
      background: var(--accent-blue);
    }
    
    .pdf-container {
      flex-grow: 1;
      position: relative;
      overflow: hidden;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
    }
    
    .google-pdf-viewer {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    
    .pdf-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      color: var(--dark-gray);
      z-index: 5;
    }
    
    .pdf-loading i {
      margin-right: 0.5rem;
    }
    
    .pdf-fallback {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      background: var(--light-gray);
    }
    
    .fallback-message {
      text-align: center;
      max-width: 300px;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .fallback-message i {
      font-size: 2rem;
      color: var(--primary-blue);
      margin-bottom: 1rem;
    }
    
    .fallback-message p {
      margin-bottom: 1.5rem;
      color: var(--dark-gray);
    }
    
    /* PDF Navigation Controls */
    .pdf-navigation {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .pdf-container:hover .pdf-navigation {
      opacity: 1;
    }
    
    .pdf-nav-button {
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }
    
    .pdf-nav-button:hover {
      background: var(--accent-blue);
      transform: scale(1.05);
    }
    
    .pdf-nav-button:active {
      transform: scale(0.95);
    }
    
    .pdf-nav-button i {
      font-size: 1.2rem;
    }
    
    .pdf-page-info {
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      min-width: 80px;
      justify-content: center;
    }
    
    /* Improved loading indicator */
    .pdf-loading {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 15px 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    /* Canvas for PDF.js */
    #pdf-canvas {
      display: block;
      margin: 0 auto;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .terms-section {
        padding: 1rem;
      }
      
      .terms-container {
        flex-direction: column;
        height: auto;
        min-height: 80vh;
      }
      
      .terms-sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--accent-blue);
      }
      
      .terms-file-list {
        flex-direction: row;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        gap: 0.5rem;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;  /* Firefox */
      }
      
      .terms-file-list::-webkit-scrollbar {
        display: none;  /* Chrome, Safari, Opera */
      }
      
      .terms-file-item {
        flex-shrink: 0;
        white-space: nowrap;
        padding: 8px 12px;
        min-width: 150px;
      }
      
      .pdf-controls {
        justify-content: center;
        padding: 12px;
      }
      
      .pdf-title {
        display: none;
      }
      
      .primary-btn {
        padding: 8px 16px;
      }
      
      .pdf-container {
        height: 65vh;
      }
      
      .pdf-navigation {
        bottom: 15px;
        opacity: 1;
      }
      
      /* Better touch targets */
      .pdf-nav-button {
        width: 56px;
        height: 56px;
      }
    }
    
    /* Small mobile adjustments */
    @media (max-width: 480px) {
      .terms-section {
        padding: 0.75rem;
      }
      
      .pdf-container {
        height: 60vh;
      }
      
      .terms-file-item {
        min-width: 130px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-container">
      <div class="logo-container">
        <div class="logo" onclick="window.location = '../index.html'"></div>
      </div>
      <!-- Navigation Placeholder -->
      <div id="nav-placeholder"></div>
      <script src="../nav-bar/nav.js"></script>
      <!-- Mobile Menu Button -->
      <button id="mobile-menu-btn" class="mobile-menu-btn">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    
    <!-- Mobile Navigation Placeholder -->
    <div id="mobile-nav-placeholder"></div>
    <script src="../mobile-nav/mobile.js"></script>
  </header>
  
  <!-- Main Content: Terms and Conditions -->
  <main class="terms-page">
    <section class="terms-section">
      <div class="terms-container">
        <div class="terms-sidebar">
          <div class="terms-file-list">
            <div id="terms-conditions-item"
                 class="terms-file-item active"
                 data-pdf="../certifications/terms-conditions.pdf">
              <i class="fas fa-file-alt"></i> Terms &amp; Conditions
            </div>
            <div id="quality-clauses-item"
                 class="terms-file-item"
                 data-pdf="../certifications/quality-clauses.pdf">
              <i class="fas fa-check-circle"></i> Quality Clauses
            </div>
          </div>
        </div>
        <div class="terms-viewer">
          <div class="pdf-controls">
            <button id="download-pdf" class="primary-btn">
              <i class="fas fa-download"></i> Download PDF
            </button>
            <span class="pdf-title">Terms &amp; Conditions</span>
          </div>
          <div class="pdf-container">
            <div id="pdf-loading" class="pdf-loading">
              <i class="fas fa-spinner fa-spin"></i> Loading PDF...
            </div>
            <iframe id="terms-frame"
                    class="google-pdf-viewer"
                    frameborder="0"
                    style="display: none;"></iframe>
            
            <!-- PDF Navigation Controls -->
            <div class="pdf-navigation">
              <button id="prev-page" class="pdf-nav-button">
                <i class="fas fa-chevron-left"></i>
              </button>
              <div class="pdf-page-info">
                Page <span id="current-page">1</span> / <span id="total-pages">?</span>
              </div>
              <button id="next-page" class="pdf-nav-button">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            
            <div class="pdf-fallback">
              <div class="fallback-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>PDF preview not available. Please download the document to view it.</p>
                <button id="fallback-download" class="primary-btn">
                  <i class="fas fa-download"></i> Download PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer Placeholder -->
  <div id="footer-placeholder"></div>
  <script src="../footer/footer.js"></script>

  <!-- Load PDF.js library for small screens -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

  <!-- Page Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fileItems         = document.querySelectorAll('.terms-file-item');
      const termsFrame        = document.getElementById('terms-frame');
      const downloadBtn       = document.getElementById('download-pdf');
      const fallbackDownload  = document.getElementById('fallback-download');
      const pdfTitle          = document.querySelector('.pdf-title');
      const pdfLoading        = document.getElementById('pdf-loading');
      const prevPageBtn       = document.getElementById('prev-page');
      const nextPageBtn       = document.getElementById('next-page');
      const currentPageEl     = document.getElementById('current-page');
      const totalPagesEl      = document.getElementById('total-pages');
      const pdfNavigation     = document.querySelector('.pdf-navigation');
      
      let activePdfUrl        = '../certifications/terms-conditions.pdf';
      let currentPage         = 1;
      let totalPages          = 1;
      let pdfDoc              = null;
      let pageRendering       = false;
      let pageNumPending      = null;
      let canvas              = null;
      let ctx                 = null;
      let scale               = 1.0;
      
      // Detect if we should use PDF.js or iframe
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      const isTablet = window.matchMedia('(max-width: 1024px)').matches && !isMobile;
      const useAdvancedRenderer = isMobile || isTablet;
      
      // Initialize the PDF.js worker if we need it
      if (useAdvancedRenderer) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
      }
      
      // Create a canvas element for PDF rendering
      function setupCanvas() {
        if (!canvas) {
          termsFrame.style.display = 'none';
          
          canvas = document.createElement('canvas');
          canvas.id = 'pdf-canvas';
          canvas.style.width = '100%';
          canvas.style.maxWidth = '100%';
          canvas.style.height = 'auto';
          canvas.style.display = 'block';
          
          const pdfContainer = document.querySelector('.pdf-container');
          pdfContainer.appendChild(canvas);
          
          ctx = canvas.getContext('2d');
        }
        
        return canvas;
      }
      
      // Show PDF directly in iframe (for desktop)
      function showPdfInIframe(pdfUrl) {
        const absoluteUrl = getAbsoluteUrl(pdfUrl);
        
        // Hide the PDF.js canvas if it exists
        if (canvas) {
          canvas.style.display = 'none';
        }
        
        // Show the iframe
        termsFrame.style.display = 'block';
        termsFrame.src = absoluteUrl;
        
        // Hide loading spinner after a short delay
        setTimeout(() => {
          pdfLoading.style.display = 'none';
        }, 1000);
        
        // Hide navigation controls for iframe view
        pdfNavigation.style.display = 'none';
      }
      
      // Render a specific PDF page with PDF.js
      function renderPage(pageNum) {
        pageRendering = true;
        
        // Show loading state while rendering
        pdfLoading.style.display = 'flex';
        
        // Get page from PDF document
        pdfDoc.getPage(pageNum).then(function(page) {
          // Determine scale to fit page width
          const viewport = page.getViewport({ scale: 1.0 });
          const parent = canvas.parentElement;
          const containerWidth = parent.clientWidth;
          scale = containerWidth / viewport.width;
          
          // Prepare canvas using PDF page dimensions
          const scaledViewport = page.getViewport({ scale: scale });
          canvas.height = scaledViewport.height;
          canvas.width = scaledViewport.width;
          
          // Render PDF page into canvas context
          const renderContext = {
            canvasContext: ctx,
            viewport: scaledViewport
          };
          
          const renderTask = page.render(renderContext);
          
          // Wait for rendering to finish
          renderTask.promise.then(function() {
            pageRendering = false;
            pdfLoading.style.display = 'none';
            
            // Update page counter
            currentPageEl.textContent = pageNum;
            
            // If another page rendering is pending, render that page
            if (pageNumPending !== null) {
              renderPage(pageNumPending);
              pageNumPending = null;
            }
          });
        });
      }
      
      // Queue new page rendering if there's already a rendering in progress
      function queueRenderPage(pageNum) {
        if (pageRendering) {
          pageNumPending = pageNum;
        } else {
          renderPage(pageNum);
        }
      }
      
      // Go to previous page
      function onPrevPage() {
        if (currentPage <= 1) return;
        currentPage--;
        queueRenderPage(currentPage);
      }
      
      // Go to next page
      function onNextPage() {
        if (currentPage >= totalPages) return;
        currentPage++;
        queueRenderPage(currentPage);
      }
      
      // Set up button events for PDF.js navigation
      prevPageBtn.addEventListener('click', onPrevPage);
      nextPageBtn.addEventListener('click', onNextPage);
      
      // Load and render PDF with PDF.js
      function loadAndRenderPdf(pdfUrl) {
        const absoluteUrl = getAbsoluteUrl(pdfUrl);
        pdfLoading.style.display = 'flex';
        
        // Set up canvas for PDF display
        setupCanvas();
        
        // Show navigation controls for PDF.js view
        pdfNavigation.style.display = 'flex';
        
        // Clean any previous PDF content and reset page counter
        if (ctx) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        currentPage = 1;
        
        // Load and initialize PDF document
        const loadingTask = window.pdfjsLib.getDocument(absoluteUrl);
        loadingTask.promise.then(function(pdf) {
          pdfDoc = pdf;
          totalPages = pdf.numPages;
          
          // Update page counter
          totalPagesEl.textContent = totalPages;
          currentPageEl.textContent = currentPage;
          
          // Initial render of the first page
          renderPage(currentPage);
        }).catch(function(error) {
          console.error('Error loading PDF:', error);
          pdfLoading.style.display = 'none';
          document.querySelector('.pdf-fallback').style.display = 'flex';
        });
      }
      
      // Main function to load PDF based on device type
      function loadPdf(pdfUrl) {
        if (useAdvancedRenderer) {
          // Mobile/tablet: Use PDF.js
          loadAndRenderPdf(pdfUrl);
        } else {
          // Desktop: Use iframe
          showPdfInIframe(pdfUrl);
        }
      }
      
      // Utility to resolve a relative URL to absolute
      function getAbsoluteUrl(url) {
        const a = document.createElement('a');
        a.href = url;
        return a.href;
      }
      
      // Initialize the PDF viewer with the active PDF URL
      loadPdf(activePdfUrl);
      
      // Sidebar click â†’ swap PDF
      fileItems.forEach(item => {
        item.addEventListener('click', () => {
          fileItems.forEach(el => el.classList.remove('active'));
          item.classList.add('active');

          activePdfUrl = item.getAttribute('data-pdf');
          pdfTitle.textContent = item.textContent.trim();
          
          // Load the new PDF
          loadPdf(activePdfUrl);
        });
      });

      // Download buttons
      downloadBtn.addEventListener('click', () => {
        window.open(getAbsoluteUrl(activePdfUrl), '_blank');
      });
      fallbackDownload.addEventListener('click', () => {
        window.open(getAbsoluteUrl(activePdfUrl), '_blank');
      });
      
      // Add keyboard navigation for PDF.js mode
      document.addEventListener('keydown', (e) => {
        if (!useAdvancedRenderer) return;
        
        if (e.key === 'ArrowLeft') {
          onPrevPage();
        } else if (e.key === 'ArrowRight') {
          onNextPage();
        }
      });

      // If someone links in with #quality-clauses-item
      if (window.location.hash === '#quality-clauses-item') {
        const qc = document.getElementById('quality-clauses-item');
        if (qc) qc.click();
      }
      
      // Add touch gestures for mobile
      let touchStartX = 0;
      let touchEndX = 0;
      
      document.querySelector('.pdf-container').addEventListener('touchstart', (e) => {
        if (!useAdvancedRenderer) return;
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });
      
      document.querySelector('.pdf-container').addEventListener('touchend', (e) => {
        if (!useAdvancedRenderer) return;
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, { passive: true });
      
      function handleSwipe() {
        const swipeThreshold = 50;
        
        if (touchEndX < touchStartX - swipeThreshold) {
          // Swiped left, go to next page
          onNextPage();
        }
        
        if (touchEndX > touchStartX + swipeThreshold) {
          // Swiped right, go to previous page
          onPrevPage();
        }
      }
      
      // Handle window resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          // Check if we need to switch between iframe and PDF.js
          const wasMobile = useAdvancedRenderer;
          const newIsMobile = window.matchMedia('(max-width: 768px)').matches;
          const newIsTablet = window.matchMedia('(max-width: 1024px)').matches && !newIsMobile;
          const newUseAdvancedRenderer = newIsMobile || newIsTablet;
          
          // If renderer type changed, reload the PDF
          if (wasMobile !== newUseAdvancedRenderer) {
            loadPdf(activePdfUrl);
          } else if (newUseAdvancedRenderer && pdfDoc) {
            // If still using PDF.js, just re-render the current page
            renderPage(currentPage);
          }
        }, 250);
      });
    });
  </script>

  <script src="../script.js" defer></script>
</body>
</html>